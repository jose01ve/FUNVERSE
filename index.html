<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUNVENSER · Reporte Diario</title>
<style>
  :root{--bg:#0f172a;--card:#0f172a;--text:#e5e7eb;--muted:#9aa4bf;--border:#24304a;--accent:#7c83ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0b1224);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:auto;padding:16px}
  .card{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter: blur(4px)}
  h1{margin:.2rem 0 1rem;font-size:1.2rem}
  label{display:block;margin-top:10px;font-size:.92rem;color:var(--muted)}
  input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
  input[readonly], select:disabled, .disabled{opacity:.75;cursor:not-allowed}
  button{cursor:pointer;margin-top:14px;background:var(--accent);border-color:transparent}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
  .ok{color:#58d68d} .bad{color:#ff6b6b} .muted{color:var(--muted)}
  .hid{display:none}

  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:24px 16px}
  .logo{width:64px;height:64px;border-radius:16px;background:conic-gradient(from 120deg,#7c83ff,#00e5ff,#00ffa5);box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .title{font-weight:700;font-size:1.4rem}
  .subtitle{color:#9aa4bf;font-size:.95rem}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modal .content{background:var(--card);border:1px solid var(--border);border-radius:12px;max-width:580px;width:100%;padding:16px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn-outline{background:transparent;border:1px solid var(--border)}
  .preview{background:#0b1224;border:1px dashed var(--border);border-radius:10px;padding:12px;margin-top:8px;font-size:.95rem}
  .readonly-banner{background:#1f2937;border:1px solid #374151;color:#93c5fd;border-radius:10px;padding:10px;margin-top:12px}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="hero">
      <div class="logo"></div>
      <div class="title">Ingresar · FUNVENSER</div>
      <div class="subtitle">Accede con tu API Key para registrar o administrar</div>
    </div>
    <label>API Key del Asesor</label>
    <input id="apiKey" placeholder="Ingresa tu API Key" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <!-- ADMIN -->
  <div class="card hid" id="adminCard">
    <h1>Admin · Asignación y Meta · FUNVENSER</h1>
    <div class="grid grid-2">
      <div><label>Ciudad</label><select id="a_ciudad"></select></div>
      <div><label>Sede</label><select id="a_sede"></select></div>
      <div><label>Máquina</label><select id="a_maquina"></select></div>
      <div><label>Asesor</label><select id="a_asesor"></select></div>
      <div><label>Meta del día</label><input id="a_meta" type="number" min="0" step="1000" value="0" /></div>
    </div>
    <button id="btnAdminGuardar">Guardar asignación/meta</button>

    <div style="margin-top:14px" class="grid grid-2">
      <div><label>Desbloquear asesor (reabrir)</label><select id="unlock_select"></select></div>
      <div style="display:flex;align-items:flex-end"><button id="btnUnlock" class="btn-outline" style="width:100%">Desbloquear</button></div>
    </div>

    <div id="adminMsg" class="muted"></div>
  </div>

  <!-- FORM ASESOR -->
  <div class="card hid" id="formCard">
    <h1>Reporte Diario</h1>

    <!-- banner de sólo lectura -->
    <div id="sentBanner" class="readonly-banner hid">
      Ya enviaste tu reporte hoy. Si necesitas corregirlo, contacta a la administradora para que te habilite nuevamente.
    </div>

    <div class="grid grid-2">
      <input id="asesorId" class="hid" />
      <div><label>Asesor</label><input id="asesorNombre" readonly /></div>
      <div><label>Fecha</label><input type="date" id="fecha" readonly /></div>

      <div><label>Ciudad</label><select id="ciudad" disabled></select></div>
      <div><label>Sede (Centro Comercial)</label><select id="sede" disabled></select></div>
      <div><label>Máquina</label><select id="maquina" disabled></select></div>

      <div><label>Marcado (monto en $)</label><input id="marcado" type="number" min="0" step="1000" value="0" /></div>
      <div><label>Error (monto en $)</label><input id="error" type="number" min="0" step="1000" value="0" placeholder="0 si no hubo" /></div>

      <div><label>Tickets vendidos (auto)</label><input id="tickets" type="number" readonly value="0" /></div>
      <div><label>Venta total (auto)</label><input id="venta" type="number" readonly value="0" /></div>

      <div><label>Meta del día (admin)</label><input id="meta" type="number" readonly value="0" /></div>
      <div><label>Gastos</label><input id="gastos" type="number" min="0" step="500" value="0" /></div>

      <div><label>QR</label><input id="qr" type="number" min="0" step="1000" value="0" /></div>
      <div><label>Consignación (la edita Admin)</label><input id="consignacion" type="number" min="0" step="1000" value="0" disabled /></div>

      <div><label>Efectivo (auto)</label><input id="efectivo" type="number" readonly value="0" /></div>
      <div><label>Pendiente por consignar (auto)</label><input id="pendiente" type="number" readonly value="0" /></div>

      <div style="grid-column:1 / -1">
        <label>Comentario</label>
        <textarea id="comentario" rows="3" placeholder="Observaciones del día"></textarea>
      </div>

      <div><label>Foto (jpg/png)</label><input id="foto" type="file" accept="image/*" /></div>
      <div><label>Video (mp4/quicktime)</label><input id="video" type="file" accept="video/*" /></div>
    </div>

    <button id="btnEnviar">Enviar reporte</button>
    <div id="msg" class="muted"></div>
  </div>
</div>

<!-- Modal confirm + PREVIEW -->
<div class="modal" id="sendModal" role="dialog" aria-modal="true">
  <div class="content">
    <h3>Confirmar envío</h3>
    <div class="preview" id="previewBox"></div>
    <div class="actions">
      <button class="btn-outline" id="btnSendCancel">Cancelar</button>
      <button id="btnSendConfirm">Sí, enviar</button>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxSB76V2O-qF1avkWnTlnm1HWFjPqWs850jk-MVQXxNhzjIyw9FUcTHO1dE4c-mPfz2/exec';

let TOKEN=null, USER=null, LISTAS=null, AID_PARAM=null;

/* Helpers */
const $=id=>document.getElementById(id);
const todayStr=()=>new Date().toISOString().slice(0,10);
const num = id => +((($(id)?.value)||'0').toString().replace(/[, ]/g,'')) || 0;
function qsParam(name){ const u=new URL(location.href); return u.searchParams.get(name)||''; }

/* Login */
async function login(){
  const api_key=$('apiKey').value.trim();
  $('loginMsg').textContent='Validando...';
  try{
    const r=await fetch(WEB_APP_URL+'?path=login',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({api_key})});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error de login');
    TOKEN=j.token; USER=j.user;

    // Si vino con ?aid=... asegúrate que coincida con el usuario logeado
    AID_PARAM = qsParam('aid');
    if (AID_PARAM && String(AID_PARAM)!==String(USER.id)){
      $('loginMsg').innerHTML='<span class="bad">Este enlace no corresponde a tu usuario.</span>';
      return;
    }

    $('asesorNombre').value=USER.nombre||''; $('asesorId').value=USER.id||'';
    $('fecha').value=todayStr();

    await cargarListas();

    if((USER.rol||'').toLowerCase()==='admin'){
      // Admin: ver panel + desbloqueo
      $('adminCard').classList.remove('hid');
      initAdminSelectors();
      // además, mostramos el formulario en modo vista previa bloqueado para que vea “cómo lo vería”
      await cargarAsignacionDelDia(true);
    }else{
      await cargarAsignacionDelDia(false);
    }

    $('loginCard').classList.add('hid');
    $('formCard').classList.remove('hid');
    recalcAuto();
  }catch(e){ $('loginMsg').innerHTML='<span class="bad">'+e.message+'</span>'; }
}

/* Listas */
async function cargarListas(){
  const r=await fetch(WEB_APP_URL+'?path=listas'); const j=await r.json(); LISTAS=j;
}

/* Pinta selects */
function fillSelect(id,arr,valKey,txtKey){ const sel=$(id); sel.innerHTML=''; arr.forEach(o=>{const op=document.createElement('option');op.value=o[valKey];op.textContent=o[txtKey];sel.appendChild(op);}); }

/* Cargar asignación (y bloquear si ya envió) */
async function cargarAsignacionDelDia(adminPreview){
  try{
    const q = new URLSearchParams({ token: TOKEN });
    const r = await fetch(WEB_APP_URL+'?path=asignacion&'+q.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Sin asignación');

    const a = j.asignacion;

    fillSelect('ciudad', LISTAS.ciudades,'id','nombre'); $('ciudad').value = a.ciudad_id;
    fillSelect('sede', LISTAS.sedes.filter(s=>s.ciudad_id===a.ciudad_id),'id','nombre'); $('sede').value = a.sede_id;
    fillSelect('maquina', LISTAS.maquinas.filter(m=>m.sede_id===a.sede_id),'id','id'); $('maquina').value = a.maquina_id;
    $('meta').value = Number(a.meta_dia||0) || 0;

    // bloquear campos no editables para el asesor
    $('ciudad').disabled = true;
    $('sede').disabled   = true;
    $('maquina').disabled= true;
    $('meta').readOnly   = true;
    $('consignacion').disabled = true;

    // Si ya envió hoy → bloquear todo envío y mostrar banner
    if (j.enviado_hoy && !adminPreview){
      $('sentBanner').classList.remove('hid');
      disableForm(true);
    }else{
      $('sentBanner').classList.add('hid');
      disableForm(false);
    }
  }catch(e){
    // Si no hay asignación, deja disabled igual (no puede reportar sin asignación)
    $('ciudad').disabled = true;
    $('sede').disabled   = true;
    $('maquina').disabled= true;
    $('meta').readOnly   = true;
    $('consignacion').disabled = true;
    $('msg').innerHTML='<span class="bad">'+(e.message||'Sin asignación para hoy')+'</span>';
    disableForm(true);
  }
}

/* Habilita/inhabilita los campos editables del asesor */
function disableForm(lock){
  ['marcado','error','gastos','qr','comentario','foto','video','btnEnviar'].forEach(id=>{
    const el=$(id); if(!el) return;
    if (id==='btnEnviar'){ el.disabled = !!lock; }
    else{
      el.disabled = !!lock;
      if (lock) el.classList.add('disabled'); else el.classList.remove('disabled');
    }
  });
}

/* Cálculos encadenados */
function recalcAuto(){
  const marcado = num('marcado');
  const error   = num('error');
  const gastos  = num('gastos');
  const qr      = num('qr');
  const cons    = num('consignacion');

  const venta = Math.max(0, marcado - error);
  $('venta').value = venta;

  // “dos primeras cifras” ya implementado previamente; si estás usando conteo normal, cambia aquí
  const tickets = Math.max(0, Math.floor(venta / 13));
  $('tickets').value = tickets;

  const efectivo = Math.max(0, venta - gastos - qr);
  $('efectivo').value = efectivo;

  const pendiente = Math.max(0, efectivo - cons);
  $('pendiente').value = pendiente;
}
['marcado','error','gastos','qr','consignacion'].forEach(id=>{
  document.addEventListener('input', e=>{ if(e.target && e.target.id===id) recalcAuto(); });
});

/* Upload */
async function uploadFile(file){
  if(!file) return '';
  const base64=await new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(String(fr.result).split(',')[1]); fr.onerror=rej; fr.readAsDataURL(file);});
  const r=await fetch(WEB_APP_URL+'?path=upload',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({token:TOKEN,fileName:file.name,mimeType:file.type,data:base64})});
  const j=await r.json(); if(!j.ok) throw new Error(j.error||'No se pudo subir'); return j.url;
}

/* Modal con PREVIEW */
function openSendConfirm(){
  // construye previsualización
  const html = `
  <b>Asesor:</b> ${$('asesorNombre').value}<br/>
  <b>Fecha:</b> ${$('fecha').value}<br/>
  <b>Ciudad:</b> ${$('ciudad').options[$('ciudad').selectedIndex]?.text}<br/>
  <b>Sede:</b> ${$('sede').options[$('sede').selectedIndex]?.text}<br/>
  <b>Máquina:</b> ${$('maquina').value}<br/>
  <hr style="border-color:#263142">
  <b>Marcado:</b> $${num('marcado').toLocaleString('es-CO')}<br/>
  <b>Error:</b> $${num('error').toLocaleString('es-CO')}<br/>
  <b>Venta total:</b> $${num('venta').toLocaleString('es-CO')}<br/>
  <b>Tickets vendidos:</b> ${num('tickets')}<br/>
  <b>Meta del día:</b> $${num('meta').toLocaleString('es-CO')}<br/>
  <b>Gastos:</b> $${num('gastos').toLocaleString('es-CO')}<br/>
  <b>QR:</b> $${num('qr').toLocaleString('es-CO')}<br/>
  <b>Efectivo:</b> $${num('efectivo').toLocaleString('es-CO')}<br/>
  <b>Consignación:</b> $${num('consignacion').toLocaleString('es-CO')}<br/>
  <b>Pendiente:</b> $${num('pendiente').toLocaleString('es-CO')}<br/>
  <b>Comentario:</b> ${$('comentario').value||'(sin comentario)'}
  `;
  $('previewBox').innerHTML = html;

  const m=$('sendModal'); m.style.display='flex';
  $('btnSendCancel').onclick=()=>m.style.display='none';
  $('btnSendConfirm').onclick=()=>{ m.style.display='none'; enviar(); };
}

/* Enviar */
async function enviar(){
  $('msg').textContent='Subiendo archivos y enviando...';
  try{
    const foto_url=await uploadFile($('foto').files[0]); const video_url=await uploadFile($('video').files[0]);
    const payload={ fecha:$('fecha').value, ciudad_id:$('ciudad').value, sede_id:$('sede').value, maquina_id:$('maquina').value, asesor_id:$('asesorId').value,
      marcado:num('marcado')||0, error:num('error')||0, tickets_vendidos:num('tickets')||0,
      venta_total:num('venta')||0, meta_dia:num('meta')||0, gastos:num('gastos')||0,
      qr:num('qr')||0, efectivo:num('efectivo')||0, consignacion:num('consignacion')||0, pendiente_consignar:num('pendiente')||0,
      comentario:$('comentario').value||'', foto_url, video_url };
    const r=await fetch(WEB_APP_URL+'?path=reporte',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({token:TOKEN,payload})});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error al registrar');

    $('msg').innerHTML='<span class="ok">✅ Reporte registrado. Tu acceso queda bloqueado por hoy.</span>';
    disableForm(true);
    $('sentBanner').classList.remove('hid');
  }catch(e){ $('msg').innerHTML='<span class="bad">❌ '+e.message+'</span>'; }
}

/* Admin UI */
function initAdminSelectors(){
  fillSelect('a_ciudad', LISTAS.ciudades,'id','nombre');
  $('a_ciudad').addEventListener('change', ()=>{
    const cid=$('a_ciudad').value;
    fillSelect('a_sede', LISTAS.sedes.filter(s=>s.ciudad_id===cid),'id','nombre');
    $('a_sede').dispatchEvent(new Event('change'));
  });
  $('a_sede').addEventListener('change', ()=>{
    const sid=$('a_sede').value;
    fillSelect('a_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
  });
  const asesores=(LISTAS.usuarios||[]).filter(u=>(u.rol||'').toLowerCase()==='asesor' && String(u.activo).toLowerCase()==='true');
  fillSelect('a_asesor', asesores,'id','nombre');

  // lista para desbloqueo
  fillSelect('unlock_select', asesores,'id','nombre');

  $('btnAdminGuardar').addEventListener('click', adminGuardar);
  $('btnUnlock').addEventListener('click', adminUnlock);
  $('a_ciudad').dispatchEvent(new Event('change'));
}

async function adminGuardar(){
  const msg=$('adminMsg'); msg.textContent='Guardando...';
  try{
    const q=new URLSearchParams({
      token:TOKEN, ciudad_id:$('a_ciudad').value, sede_id:$('a_sede').value,
      maquina_id:$('a_maquina').value, asesor_id:$('a_asesor').value,
      meta_sugerida:String(+$('a_meta').value||0)
    });
    const r=await fetch(WEB_APP_URL+'?path=admin_set&'+q.toString());
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'No se pudo guardar');

    msg.innerHTML='<span class="ok">✔ Guardado y notificado por email</span>';
  }catch(e){ msg.innerHTML='<span class="bad">❌ '+e.message+'</span>'; }
}
async function adminUnlock(){
  const msg=$('adminMsg'); msg.textContent='Desbloqueando...';
  try{
    const r=await fetch(WEB_APP_URL+'?path=admin_unlock',{
      method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({ token:TOKEN, asesor_id:$('unlock_select').value })
    });
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'No se pudo desbloquear');
    msg.innerHTML='<span class="ok">✔ Asesor desbloqueado</span>';
  }catch(e){ msg.innerHTML='<span class="bad">❌ '+e.message+'</span>'; }
}

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  $('btnLogin').addEventListener('click', login);
  $('btnEnviar').addEventListener('click', openSendConfirm);
});
</script>
</body>
</html>
