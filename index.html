<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUNVENSER · Reportes</title>
<style>
  :root{--bg:#0f172a;--card:#0f172a;--text:#e5e7eb;--muted:#9aa4bf;--border:#24304a;--accent:#7c83ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0b1224);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:auto;padding:16px}
  .card{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter: blur(4px)}
  h1{margin:.4rem 0 1rem;font-size:1.2rem}
  label{display:block;margin-top:10px;font-size:.92rem;color:var(--muted)}
  input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
  input[readonly], select:disabled, textarea[readonly]{opacity:.85;cursor:not-allowed}
  button{cursor:pointer;margin-top:14px;background:var(--accent);border-color:transparent}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
  .ok{color:#58d68d} .bad{color:#ff6b6b} .muted{color:var(--muted)}
  .hid{display:none}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .note{margin-top:6px;font-size:.95rem}
</style>
</head>
<body>
<div class="wrap">
  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h1>Ingresar · FUNVENSER</h1>
    <label>API Key</label>
    <input id="apiKey" placeholder="Ingresa tu API Key" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <!-- ADMIN -->
  <div class="card hid" id="adminCard">
    <h1>Admin · Asignación y Meta · FUNVENSER</h1>
    <div class="grid grid-2">
      <div><label>Ciudad</label><select id="a_ciudad"></select></div>
      <div><label>Sede</label><select id="a_sede"></select></div>
      <div><label>Máquina</label><select id="a_maquina"></select></div>
      <div><label>Asesor</label><select id="a_asesor"></select></div>
      <div><label>Meta del día</label><input id="a_meta" inputmode="numeric" value="$ 0" /></div>
      <div><label>Fecha de asignación</label><input id="a_fecha" type="date" /></div>
    </div>
    <div class="row">
      <button id="btnAdminGuardar">Guardar asignación/meta</button>
    </div>

    <h1 style="margin-top:22px">Vista previa (lo que verá el asesor)</h1>
    <div class="card" style="background:#0b1224" id="adminPreview"></div>

    <h1 style="margin-top:22px">Eliminar reporte</h1>
    <div class="grid grid-2">
      <div><label>Asesor</label><select id="del_asesor"></select></div>
      <div><label>Máquina (opcional)</label><select id="del_maquina"></select></div>
      <div><label>Fecha a eliminar</label><input id="del_fecha" type="date" /></div>
    </div>
    <div class="row">
      <button class="btn-outline" id="btnDelete">Eliminar reporte</button>
    </div>
    <div id="adminMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- ASESOR -->
  <div class="card hid" id="formCard">
    <h1>Reporte Diario</h1>
    <div class="grid grid-2">
      <input id="asesorId" class="hid" />
      <div><label>Asesor</label><input id="asesorNombre" readonly /></div>
      <div><label>Fecha</label><input id="fecha" readonly /></div>

      <div><label>Ciudad</label><select id="ciudad" disabled></select></div>
      <div><label>Sede (Centro Comercial)</label><select id="sede" disabled></select></div>
      <div><label>Máquina</label><select id="maquina" disabled></select></div>

      <div><label>Marcado (monto en $)</label><input id="marcado" value="$ 0" /></div>
      <div><label>Error (monto en $)</label><input id="error" value="$ 0" /></div>

      <div><label>Tickets vendidos (auto)</label><input id="tickets" type="number" readonly value="0" /></div>
      <div><label>Venta total (auto)</label><input id="venta" readonly value="$ 0" /></div>

      <div><label>Meta del día (admin)</label><input id="meta" readonly value="$ 0" /></div>
      <div><label>Gastos</label><input id="gastos" value="$ 0" /></div>

      <div><label>QR</label><input id="qr" value="$ 0" /></div>
      <div><label>Consignación (la edita Admin)</label><input id="consignacion" readonly value="$ 0" /></div>

      <div><label>Efectivo (auto)</label><input id="efectivo" readonly value="$ 0" /></div>
      <div><label>Pendiente por consignar (auto)</label><input id="pendiente" readonly value="$ 0" /></div>

      <div style="grid-column:1 / -1">
        <label>Faltante de Meta (auto = Venta – Meta)</label>
        <input id="faltante" readonly value="$ 0" />
      </div>

      <div style="grid-column:1 / -1">
        <div id="motivacion" class="note"></div>
      </div>

      <div style="grid-column:1 / -1">
        <label>Comentario</label>
        <textarea id="comentario" rows="3" placeholder="Observaciones del día"></textarea>
      </div>

      <div><label>Foto (jpg/png)</label><input id="foto" type="file" accept="image/*" /></div>
      <div><label>Video (mp4/quicktime)</label><input id="video" type="file" accept="video/*" /></div>
    </div>

    <button id="btnEnviar">Enviar reporte</button>
    <div id="msg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwltaZWNR6UxWLoIqeD90NXlv_Igkbkjx-gEk79cQ-w96_7HMHImKFOgIekFAaOo2gK/exec';

let TOKEN=null, USER=null, LISTAS=null, AID_PARAM=null;

/* ========= HELPERS ========= */
const $=id=>document.getElementById(id);
const toDMY = d => {
  const dt = (d instanceof Date) ? d : new Date(d);
  const dd = String(dt.getDate()).padStart(2,'0');
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const yy = dt.getFullYear();
  return `${dd}-${mm}-${yy}`;
};
const todayStr=()=>toDMY(new Date());

// --- formateo dinero ---
const cleanNum = (s) => Number(String(s||'0').replace(/[^\d-]/g,''))||0;
const fmtCOP  = (n) => `$ ${Number(n||0).toLocaleString('es-CO')}`;
const getMoney = (id) => cleanNum($(id).value);
const setMoney = (id,val) => { $(id).value = fmtCOP(val); };
const setPlain = (id,val) => { $(id).value = String(val); };

function setMsg(el, html){ el.innerHTML = html; }

/* ========= LOGIN ========= */
async function login(){
  const api_key=$('apiKey').value.trim();
  setMsg($('loginMsg'),'Validando...');
  try{
    const body = { api_key }; if (AID_PARAM) body.aid = AID_PARAM;
    const r=await fetch(WEB_APP_URL+'?path=login',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error de login');
    TOKEN=j.token; USER=j.user;

    await cargarListas();
    if((USER.rol||'').toLowerCase()==='admin'){
      $('adminCard').classList.remove('hid');
      initAdminSelectors();
      setMsg($('loginMsg'),'<span class="ok">Acceso admin</span>');
    }else{
      $('formCard').classList.remove('hid');
      $('asesorId').value = USER.id;
      $('asesorNombre').value = USER.nombre;
      await cargarAsignacionDelDia();
      recalc();
      setMsg($('loginMsg'),'<span class="ok">Acceso asesor</span>');
    }
    $('loginCard').classList.add('hid');
  }catch(e){ setMsg($('loginMsg'),'<span class="bad">'+e.message+'</span>'); }
}

/* ========= LISTAS ========= */
async function cargarListas(){
  const r=await fetch(WEB_APP_URL+'?path=listas'); const j=await r.json(); LISTAS=j;
  fillSelect('ciudad', j.ciudades,'id','nombre'); $('ciudad').disabled = true;
}
function fillSelect(id,arr,valKey,txtKey){
  const sel=$(id); sel.innerHTML=''; (arr||[]).forEach(o=>{
    const op=document.createElement('option');op.value=o[valKey];op.textContent=o[txtKey];sel.appendChild(op);
  });
}

/* ========= ASESOR: obtener asignación ========= */
async function cargarAsignacionDelDia(){
  try{
    const q = new URLSearchParams({ token: TOKEN });
    const r = await fetch(WEB_APP_URL+'?path=asignacion&'+q.toString());
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Sin asignación');

    const a = j.asignacion;

    // Mostrar fecha asignada
    $('fecha').value = a.fecha;

    fillSelect('ciudad', LISTAS.ciudades,'id','nombre'); $('ciudad').value = a.ciudad_id;
    fillSelect('sede', LISTAS.sedes.filter(s=>s.ciudad_id===a.ciudad_id),'id','nombre'); $('sede').value = a.sede_id;
    fillSelect('maquina', LISTAS.maquinas.filter(m=>m.sede_id===a.sede_id),'id','id'); $('maquina').value = a.maquina_id;

    setMoney('meta', a.meta_dia||0);

    ['ciudad','sede','maquina','meta'].forEach(id=>$(id).disabled=true);
  }catch(e){
    setMsg($('msg'), '<span class="bad">No tienes asignación.</span>');
  }
}

/* ========= CÁLCULOS ========= */
function recalc(){
  const marcado = getMoney('marcado');
  const error   = getMoney('error');
  const gastos  = getMoney('gastos');
  const qr      = getMoney('qr');
  const cons    = getMoney('consignacion');
  const meta    = getMoney('meta');

  const venta = Math.max(0, marcado - error);
  setMoney('venta', venta);

  const tickets = Math.max(0, Math.trunc(venta / 13));
  setPlain('tickets', tickets);

  const efectivo = Math.max(0, venta - gastos - qr);
  setMoney('efectivo', efectivo);

  const pendiente = Math.max(0, efectivo - cons);
  setMoney('pendiente', pendiente);

  // Faltante de Meta (mostrar 0 si cumplió; si no, número negativo con "-")
  const delta = venta - meta;
  const faltanteMostrar = (delta >= 0) ? 0 : (delta); // negativo si no cumplió
  const faltanteText = (faltanteMostrar >= 0) ? fmtCOP(0) : (`$ ${Math.abs(faltanteMostrar).toLocaleString('es-CO', {useGrouping:true})}`.replace('$','$ -'));
  $('faltante').value = (delta >=0 ? '$ 0' : faltanteText);

  // Mensaje motivacional
  if (delta >= 0){
    $('motivacion').innerHTML = '✓ <b>Meta cumplida</b>. ¡Buen cierre!';
    $('motivacion').className = 'note ok';
  }else{
     $('motivacion').innerHTML = '✓ <b>No cumpliste la meta</b>. ¡Se que puedes!';
    $('motivacion').className = 'note bad';
  }
}

// listeners de dinero
['marcado','error','gastos','qr'].forEach(id=>{
  $(id).addEventListener('input', e=>{
    const raw = cleanNum(e.target.value);
    e.target.value = fmtCOP(raw);
    recalc();
  });
});

/* ========= Upload a Drive ========= */
async function uploadFile(file){
  if(!file) return '';
  const base64=await new Promise((res,rej)=>{
    const fr=new FileReader(); fr.onload=()=>res(String(fr.result).split(',')[1]); fr.onerror=rej; fr.readAsDataURL(file);
  });
  const r=await fetch(WEB_APP_URL+'?path=upload',{method:'POST',headers:{'Content-Type':'text/plain'},
    body:JSON.stringify({token:TOKEN,fileName:file.name,mimeType:file.type,data:base64})});
  const j=await r.json(); if(!j.ok) throw new Error(j.error||'No se pudo subir'); return j.url;
}

/* ========= Envío ========= */
async function enviar(){
  setMsg($('msg'),'Enviando...');
  try{
    const foto_url=await uploadFile($('foto').files[0]);
    const video_url=await uploadFile($('video').files[0]);

    // Números puros para backend
    const payload={
      fecha:$('fecha').value, // dd-MM-yyyy
      ciudad_id:$('ciudad').value,
      sede_id:$('sede').value,
      maquina_id:$('maquina').value,
      asesor_id:$('asesorId').value,

      marcado: getMoney('marcado'),
      error: getMoney('error'),
      venta_total: getMoney('venta'),
      tickets_vendidos: Number($('tickets').value)||0,

      meta_dia: getMoney('meta'),
      gastos: getMoney('gastos'),
      qr: getMoney('qr'),
      efectivo: getMoney('efectivo'),
      consignacion: getMoney('consignacion'),
      pendiente_consignar: getMoney('pendiente'),

      // guardar 0 si cumplió, negativo si faltó
      faltante_meta: Math.min(0, getMoney('venta') - getMoney('meta')),

      comentario:$('comentario').value||'',
      foto_url, video_url
    };

    const r=await fetch(WEB_APP_URL+'?path=reporte',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({token:TOKEN,payload})});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error al registrar');

    setMsg($('msg'),'<span class="ok">✅ Reporte registrado.</span>');
  }catch(e){ setMsg($('msg'),'<span class="bad">❌ '+e.message+'</span>'); }
}

/* ========= ADMIN ========= */
function initAdminSelectors(){
  // fills
  fillSelect('a_ciudad', LISTAS.ciudades,'id','nombre');
  $('a_ciudad').addEventListener('change', ()=>{
    const cid=$('a_ciudad').value;
    fillSelect('a_sede', LISTAS.sedes.filter(s=>s.ciudad_id===cid),'id','nombre');
    $('a_sede').dispatchEvent(new Event('change'));
  });
  $('a_sede').addEventListener('change', ()=>{
    const sid=$('a_sede').value;
    fillSelect('a_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
    fillSelect('del_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
    syncAdminPreview();
  });
  const asesores=(LISTAS.usuarios||[]).filter(u=>(u.rol||'').toLowerCase()==='asesor' && String(u.activo).toLowerCase()==='true');
  fillSelect('a_asesor', asesores,'id','nombre');
  fillSelect('del_asesor', asesores,'id','nombre');

  // defaults
  $('a_fecha').valueAsDate = new Date();
  $('del_fecha').valueAsDate = new Date();

  // formateo meta admin
  $('a_meta').value = '$ 0';
  $('a_meta').addEventListener('input', e=>{ e.target.value = fmtCOP(cleanNum(e.target.value)); syncAdminPreview(); });

  ['a_asesor','a_ciudad','a_sede','a_maquina','a_fecha'].forEach(id=>$(id).addEventListener('input', syncAdminPreview));
  $('a_ciudad').dispatchEvent(new Event('change'));

  $('btnAdminGuardar').addEventListener('click', adminGuardar);
  $('btnDelete').addEventListener('click', adminDeleteReport);
  syncAdminPreview();
}
function syncAdminPreview(){
  const ciudad = $('a_ciudad').options[$('a_ciudad').selectedIndex]?.text || '';
  const sede   = $('a_sede').options[$('a_sede').selectedIndex]?.text || '';
  const maq    = $('a_maquina').value || '';
  const asesor = $('a_asesor').options[$('a_asesor').selectedIndex]?.text || '';
  const meta   = cleanNum($('a_meta').value);
  const f      = $('a_fecha').value ? toDMY(new Date($('a_fecha').value)) : todayStr();
  $('adminPreview').innerHTML =
    `<div><b>Fecha:</b> ${f}</div>
     <div><b>Ciudad:</b> ${ciudad}</div>
     <div><b>Sede:</b> ${sede}</div>
     <div><b>Máquina:</b> ${maq}</div>
     <div><b>Asesor:</b> ${asesor}</div>
     <div><b>Meta del día:</b> ${fmtCOP(meta)}</div>`;
}
async function adminGuardar(){
  const msg=$('adminMsg'); setMsg(msg,'Guardando...');
  try{
    const q=new URLSearchParams({
      token:TOKEN,
      ciudad_id:$('a_ciudad').value,
      sede_id:$('a_sede').value,
      maquina_id:$('a_maquina').value,
      asesor_id:$('a_asesor').value,
      meta_sugerida:String(cleanNum($('a_meta').value)||0),
      fecha: toDMY(new Date($('a_fecha').value))
    });
    const r=await fetch(WEB_APP_URL+'?path=admin_set&'+q.toString());
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'No se pudo guardar');
    setMsg(msg,'<span class="ok">✔ Guardado y notificado por email</span>');
  }catch(e){ setMsg($('adminMsg'),'<span class="bad">❌ '+e.message+'</span>'); }
}
async function adminDeleteReport(){
  const msg=$('adminMsg'); setMsg(msg,'Eliminando...');
  try{
    const q=new URLSearchParams({
      token:TOKEN,
      asesor_id:$('del_asesor').value,
      maquina_id:$('del_maquina').value||'',
      fecha: toDMY(new Date($('del_fecha').value))
    });
    const r=await fetch(WEB_APP_URL+'?path=admin_delete&'+q.toString());
    const j=await r.json();
    if (!j.ok){
      setMsg(msg, `<span class="bad">❌ ${j.error || 'No hay reporte para eliminar'}</span>`);
      return;
    }
    setMsg(msg, `<span class="ok">✔ Eliminados · Reportes: ${j.removed_reportes||0} · Asignaciones: ${j.removed_asignaciones||0}</span>`);
  }catch(e){
    setMsg($('adminMsg'), `<span class="bad">❌ ${e.message || 'No hay reporte para eliminar'}</span>`);
  }
}

/* ========= INIT ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  const url = new URL(location.href);
  AID_PARAM = url.searchParams.get('aid') || null;
  $('btnLogin').addEventListener('click', login);
  $('btnEnviar').addEventListener('click', enviar);

  // formateo inicial de campos dinero
  ['marcado','error','gastos','qr'].forEach(id=>{ $(id).value='$ 0'; });
});
</script>
</body>
</html>
