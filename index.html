<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FUNVENSER</title>

<style>
    body{
        margin:0;
        font-family:system-ui,Segoe UI,Roboto,Arial;
        background:#0f1321;
        color:white;
    }
    .container{
        max-width:900px;
        margin:auto;
        padding:20px;
    }
    .card{
        background:#111827;
        padding:25px;
        border-radius:15px;
        margin-top:25px;
        box-shadow:0 0 25px rgba(0,0,0,0.2);
    }
    select,input,textarea{
        width:100%;
        padding:10px;
        border-radius:8px;
        border:none;
        margin-top:7px;
        margin-bottom:12px;
        background:#f1f5f9;
        font-size:15px;
    }
    button{
        width:100%;
        padding:12px;
        margin-top:10px;
        border:none;
        border-radius:8px;
        background:#7b85ff;
        color:white;
        font-size:16px;
        cursor:pointer;
    }
    button:hover{
        background:#6570f8;
    }
    .ok{ color:#4ade80; }
    .bad{ color:#f87171; }

    .hidden{ display:none; }
</style>
</head>

<body>

<div class="container">

    <!-- ============= LOGIN ============= -->
    <div id="viewLogin" class="card">
        <h2 style="text-align:center;margin-top:0;">
            <img src="https://cdn-icons-png.flaticon.com/512/1057/1057214.png" width="65"><br>
            Ingresar ¬∑ FUNVENSER
        </h2>
        <p style="text-align:center">Usa tu API Key para acceder</p>

        <label>API Key</label>
        <input id="login_api" placeholder="Ingresa tu API Key">

        <button id="btnLogin">Entrar</button>

        <div id="loginMsg" style="margin-top:15px;text-align:center;"></div>
    </div>


    <!-- ============= DASHBOARD ASESOR ============= -->
    <div id="viewAsesor" class="card hidden">
        <h2>Panel Asesor ¬∑ FUNVENSER</h2>

        <div id="asignacionBox" style="margin-bottom:20px"></div>

        <h3>Registrar reporte de venta</h3>

        <label>Marcado</label>
        <input id="r_marcado" type="number">

        <label>Error</label>
        <input id="r_error" type="number">

        <label>Gastos</label>
        <input id="r_gastos" type="number">

        <label>QR</label>
        <input id="r_qr" type="number">

        <label>Consignaci√≥n</label>
        <input id="r_cons" type="number">

        <label>Comentario</label>
        <textarea id="r_com"></textarea>

        <label>Foto (opcional)</label>
        <input type="file" id="r_foto">

        <label>Video (opcional)</label>
        <input type="file" id="r_video">

        <button id="btnEnviarReporte">Enviar reporte</button>

        <div id="repMsg" style="margin-top:15px;"></div>
    </div>


    <!-- ============= PANEL ADMIN ============= -->
    <div id="viewAdmin" class="card hidden">
        <h2>Admin ¬∑ Asignaci√≥n y Meta ¬∑ FUNVENSER</h2>

        <label>Ciudad</label>
        <select id="a_ciudad"></select>

        <label>Sede</label>
        <select id="a_sede"></select>

        <label>M√°quina</label>
        <select id="a_maquina"></select>

        <label>Asesor</label>
        <select id="a_asesor"></select>

        <label>Fecha de asignaci√≥n</label>
        <input id="a_fecha" type="date">

        <label>Meta del d√≠a</label>
        <input id="a_meta">

        <button id="btnAsignar">Guardar asignaci√≥n/meta</button>

        <h3>Vista previa</h3>
        <div id="previewAsign" style="background:#0d1527;padding:15px;border-radius:8px;height:160px;"></div>

        <br><hr><br>

        <h2>Eliminar reporte</h2>

        <label>Asesor</label>
        <select id="del_asesor"></select>

        <label>M√°quina (opcional)</label>
        <select id="del_maquina"></select>

        <label>Fecha a eliminar</label>
        <input type="date" id="del_fecha">

        <button id="btnDelete">Eliminar reporte</button>

        <div id="adminMsg" style="margin-top:15px;"></div>
    </div>

</div>

<script>

/* ======================================================
   CONFIG
====================================================== */

// üî•üî•üî• EDITA ESTA L√çNEA üî•üî•üî•
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxrtHfWX5YBq15Akg2FOJkk8VrsWupQj2DsoOTIDB7Hkj21Go09fVZnT9y-kBMd5KWP/exec";

let TOKEN = "";
let USER = null;
let LISTAS = null;

/* ======================================================
   HELPERS
====================================================== */

function $(id){ return document.getElementById(id); }

function setMsg(el, msg){
    el.innerHTML = msg;
}

function normalizeToDMY(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
}

function toDateInput(dmy){
    if(!dmy) return "";
    const p = dmy.split("-");
    return `${p[2]}-${p[1]}-${p[0]}`;
}

/* ======================================================
   LOGIN
====================================================== */

$("btnLogin").onclick = async ()=>{
    const api = $("login_api").value.trim();
    setMsg($("loginMsg"),"Validando...");

    try{
        const r = await fetch(WEB_APP_URL+"?path=login",{
            method:"POST",
            headers:{ "Content-Type":"text/plain" },
            body: JSON.stringify({ api_key:api })
        });

        const j = await r.json();
        if(!j.ok){
            setMsg($("loginMsg"),`<span class="bad">‚ùå ${j.error}</span>`);
            return;
        }

        TOKEN = j.token;
        USER = j.user;

        $("viewLogin").classList.add("hidden");

        if(USER.rol.toLowerCase()==="admin"){
            $("viewAdmin").classList.remove("hidden");
            initAdmin();
        }else{
            $("viewAsesor").classList.remove("hidden");
            initAsesor();
        }

    }catch(e){
        setMsg($("loginMsg"),`<span class="bad">‚ùå Error de conexi√≥n</span>`);
    }
};

/* ======================================================
   LISTAS
====================================================== */

async function loadListas(){
    const r = await fetch(WEB_APP_URL+"?path=listas");
    const j = await r.json();
    LISTAS = j;
}

/* ======================================================
   PANEL ASESOR
====================================================== */

async function initAsesor(){
    await loadListas();

    const r = await fetch(WEB_APP_URL+"?path=asignacion&token="+TOKEN);
    const j = await r.json();

    if(!j.ok){
        $("asignacionBox").innerHTML = `<span class="bad">${j.error}</span>`;
        return;
    }

    const a = j.asignacion;
    $("asignacionBox").innerHTML =
    `<b>Fecha:</b> ${a.fecha}<br>
     <b>Ciudad:</b> ${a.ciudad_id}<br>
     <b>Sede:</b> ${a.sede_id}<br>
     <b>M√°quina:</b> ${a.maquina_id}<br>
     <b>Meta:</b> ${a.meta_dia}<br>`;

    $("btnEnviarReporte").onclick = enviarReporte;
}

async function enviarReporte(){
    const payload = {
        fecha: hoyDMY(),
        ciudad_id: "", // backend ya tiene asignaci√≥n
        sede_id: "",
        maquina_id: "",
        asesor_id: USER.id,
        marcado: $("r_marcado").value,
        error: $("r_error").value,
        gastos: $("r_gastos").value,
        qr: $("r_qr").value,
        consignacion: $("r_cons").value,
        comentario: $("r_com").value
    };

    let foto64="", video64="";

    const f = $("r_foto").files[0];
    const v = $("r_video").files[0];

    if(f) foto64 = await toBase64(f);
    if(v) video64 = await toBase64(v);

    const body = { token:TOKEN, payload:payload };

    if(foto64){
        const r1 = await uploadFile(f,"image");
        body.payload.foto_url = r1.url;
    }

    if(video64){
        const r2 = await uploadFile(v,"video");
        body.payload.video_url = r2.url;
    }

    const r = await fetch(WEB_APP_URL+"?path=reporte",{
        method:"POST",
        headers:{ "Content-Type":"text/plain" },
        body: JSON.stringify(body)
    });

    const j = await r.json();
    if(!j.ok){
        setMsg($("repMsg"), `<span class="bad">‚ùå ${j.error}</span>`);
        return;
    }

    setMsg($("repMsg"), `<span class="ok">‚úî Reporte enviado</span>`);
}

function hoyDMY(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
}

function toBase64(file){
    return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload=()=>resolve(r.result.split(",")[1]);
        r.onerror=reject;
        r.readAsDataURL(file);
    });
}

async function uploadFile(file,type){
    const base64 = await toBase64(file);
    const r = await fetch(WEB_APP_URL+"?path=upload",{
        method:"POST",
        headers:{ "Content-Type":"text/plain" },
        body: JSON.stringify({
            token:TOKEN,
            fileName:file.name,
            mimeType:file.type,
            data:base64
        })
    });
    return await r.json();
}

/* ======================================================
   PANEL ADMIN
====================================================== */

async function initAdmin(){
    await loadListas();

    fillSelect($("a_ciudad"), LISTAS.ciudades, "id", "nombre");
    fillSelect($("a_sede"), LISTAS.sedes, "id", "nombre");
    fillSelect($("a_maquina"), LISTAS.maquinas, "id", "id");
    fillSelect($("a_asesor"), LISTAS.usuarios.filter(u=>u.rol==="Asesor"), "id", "nombre");

    fillSelect($("del_asesor"), LISTAS.usuarios.filter(u=>u.rol==="Asesor"), "id", "nombre");
    fillSelect($("del_maquina"), LISTAS.maquinas, "id", "id");

    $("btnAsignar").onclick = adminSet;
    $("btnDelete").onclick = adminDeleteReport;
}

function fillSelect(sel, list, val, txt){
    sel.innerHTML = "";
    list.forEach(o=>{
        const op = document.createElement("option");
        op.value=o[val];
        op.textContent=o[txt];
        sel.appendChild(op);
    });
}

async function adminSet(){
    const msg = $("adminMsg");
    msg.innerHTML = "Guardando...";

    const body = {
        token:TOKEN,
        ciudad_id:$("a_ciudad").value,
        sede_id:$("a_sede").value,
        maquina_id:$("a_maquina").value,
        asesor_id:$("a_asesor").value,
        fecha: normalizeToDMY($("a_fecha").value),
        meta_sugerida:$("a_meta").value
    };

    const r = await fetch(WEB_APP_URL+"?path=admin_set",{
        method:"POST",
        headers:{ "Content-Type":"text/plain" },
        body: JSON.stringify(body)
    });

    const j = await r.json();
    if(!j.ok){
        msg.innerHTML = `<span class="bad">‚ùå ${j.error}</span>`;
        return;
    }

    msg.innerHTML = `<span class="ok">‚úî Asignaci√≥n guardada</span>`;
}

/* ======================================================
   ELIMINAR REPORTE  ‚Äî  FUNCIONA ‚úî
====================================================== */

async function adminDeleteReport(){
    const msg = $("adminMsg");
    msg.innerHTML = "Eliminando...";

    try{
        const body = {
            token:TOKEN,
            asesor_id:$("del_asesor").value,
            maquina_id:$("del_maquina").value,
            fecha: normalizeToDMY($("del_fecha").value)
        };

        await fetch(WEB_APP_URL+"?path=admin_delete",{
            method:"POST",
            mode:"no-cors",
            headers:{ "Content-Type":"text/plain" },
            body: JSON.stringify(body)
        });

        msg.innerHTML =
        `<span class="ok">‚úî Solicitud enviada. Revisa las hojas "Reportes" y "Asignaciones".</span>`;

    }catch(e){
        msg.innerHTML = `<span class="bad">‚ùå No se pudo enviar: ${e.message}</span>`;
    }
}

</script>

</body>
</html>
