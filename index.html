<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUNVENSER ¬∑ Reportes</title>
<style>
  :root{
    --bg:#0f172a;--card:#0f172a;--text:#e5e7eb;--muted:#9aa4bf;
    --border:#24304a;--accent:#7c83ff;--ok:#4ade80;--bad:#fb7185
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,var(--bg),#0b1224);
    color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial
  }
  .wrap{max-width:980px;margin:auto;padding:16px}
  .card{
    background:rgba(17,24,39,.85);border:1px solid var(--border);
    border-radius:16px;padding:16px;
    box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(4px)
  }
  h1{margin:.4rem 0 1rem;font-size:1.2rem}
  label{display:block;margin-top:10px;font-size:.92rem;color:var(--muted)}
  input,select,textarea,button{
    width:100%;padding:10px;border-radius:10px;
    border:1px solid var(--border);background:#0b1224;color:var(--text)
  }
  input[readonly],select:disabled,textarea[readonly]{opacity:.85;cursor:not-allowed}
  button{cursor:pointer;margin-top:14px;background:var(--accent);border-color:transparent}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
  .hid{display:none}
  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:24px 16px}
  .logo{
    width:64px;height:64px;border-radius:16px;
    background:conic-gradient(from 120deg,#7c83ff,#00e5ff,#00ffa5);
    box-shadow:0 6px 18px rgba(0,0,0,.35)
  }
  .title{font-weight:700;font-size:1.4rem}
  .subtitle{color:#9aa4bf;font-size:.95rem}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    border:1px solid var(--border);background:#0b1224;
    font-size:.92rem;margin-top:8px
  }
  .pill.ok{border-color:rgba(74,222,128,.25);background:rgba(74,222,128,.08)}
  .pill.bad{border-color:rgba(251,113,133,.25);background:rgba(251,113,133,.08)}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;
    padding:16px;z-index:50
  }
  .modal .content{
    background:var(--card);border:1px solid var(--border);
    border-radius:12px;max-width:620px;width:100%;padding:16px
  }
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn-outline{background:transparent;border:1px solid var(--border)}
  .preview{
    background:#0b1224;border:1px solid var(--border);
    border-radius:10px;padding:12px;font-size:.93rem
  }
  .preview b{color:#fff}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="hero">
      <div class="logo"></div>
      <div class="title">Ingresar ¬∑ FUNVENSER</div>
      <div class="subtitle">Usa tu API Key para acceder</div>
    </div>
    <label>API Key</label>
    <input id="apiKey" placeholder="Ingresa tu API Key" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <!-- ADMIN -->
  <div class="card hid" id="adminCard">
    <h1>Admin ¬∑ Asignaci√≥n y Meta ¬∑ FUNVENSER</h1>
    <div class="grid grid-2">
      <div><label>Ciudad</label><select id="a_ciudad"></select></div>
      <div><label>Sede</label><select id="a_sede"></select></div>
      <div><label>M√°quina</label><select id="a_maquina"></select></div>
      <div><label>Asesor</label><select id="a_asesor"></select></div>
      <div><label>Meta del d√≠a</label><input id="a_meta" type="text" inputmode="numeric" value="$ 0" /></div>
      <div><label>Fecha de asignaci√≥n</label><input id="a_fecha" type="date"/></div>
    </div>
    <div class="row">
      <button id="btnAdminGuardar">Guardar asignaci√≥n/meta</button>
    </div>

    <h1 style="margin-top:22px">Vista previa (lo que ver√° el asesor)</h1>
    <div class="preview" id="adminPreview"></div>

    <h1 style="margin-top:22px">Eliminar reporte</h1>
    <div class="grid grid-2">
      <div><label>Asesor</label><select id="del_asesor"></select></div>
      <div><label>M√°quina (opcional)</label><select id="del_maquina"></select></div>
      <div><label>Fecha a eliminar</label><input id="del_fecha" type="date"/></div>
    </div>
    <div class="row">
      <button class="btn-outline" id="btnDelete">Eliminar reporte</button>
    </div>
    <div id="adminMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- ASESOR -->
  <div class="card hid" id="formCard">
    <h1>Reporte Diario</h1>
    <div class="grid grid-2">
      <input id="asesorId" class="hid" />
      <div><label>Asesor</label><input id="asesorNombre" readonly /></div>
      <div><label>Fecha</label><input id="fecha" readonly /></div>

      <div><label>Ciudad</label><select id="ciudad" disabled></select></div>
      <div><label>Sede (Centro Comercial)</label><select id="sede" disabled></select></div>
      <div><label>M√°quina</label><select id="maquina" disabled></select></div>

      <div><label>Marcado (monto en $)</label><input id="marcado" type="text" inputmode="numeric" value="$ 0" /></div>
      <div><label>Error (monto en $)</label><input id="error" type="text" inputmode="numeric" value="$ 0" /></div>

      <div><label>Tickets vendidos (auto)</label><input id="tickets" type="number" readonly value="0" /></div>
      <div><label>Venta total (auto)</label><input id="venta" type="text" readonly value="$ 0" /></div>

      <div><label>Meta del d√≠a (admin)</label><input id="meta" type="text" readonly value="$ 0" /></div>
      <div><label>Gastos</label><input id="gastos" type="text" inputmode="numeric" value="$ 0" /></div>

      <div><label>QR</label><input id="qr" type="text" inputmode="numeric" value="$ 0" /></div>
      <div><label>Consignaci√≥n (la edita Admin)</label><input id="consignacion" type="text" value="$ 0" readonly /></div>

      <div><label>Efectivo (auto)</label><input id="efectivo" type="text" readonly value="$ 0" /></div>
      <div><label>Pendiente por consignar (auto)</label><input id="pendiente" type="text" readonly value="$ 0" /></div>

      <div style="grid-column:1 / -1">
        <label>Faltante de Meta (auto = Meta ‚àí Venta)</label>
        <input id="faltante" readonly value="$ 0" />
      </div>

      <div style="grid-column:1 / -1" id="feedback"></div>

      <div style="grid-column:1 / -1">
        <label>Comentario</label>
        <textarea id="comentario" rows="3" placeholder="Observaciones del d√≠a"></textarea>
      </div>

      <div><label>Foto (jpg/png)</label><input id="foto" type="file" accept="image/*" /></div>
      <div><label>Video (mp4/quicktime)</label><input id="video" type="file" accept="video/*" /></div>
    </div>

    <button id="btnEnviar">Enviar reporte</button>
    <div id="msg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- Modal confirm env√≠o -->
<div class="modal" id="sendModal" role="dialog" aria-modal="true">
  <div class="content">
    <h3>Confirmar env√≠o</h3>
    <div class="preview" id="sendPreview" style="margin-top:8px"></div>
    <div class="actions">
      <button class="btn-outline" id="btnSendCancel">Cancelar</button>
      <button id="btnSendConfirm">S√≠, enviar</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
/* üîó Pega aqu√≠ la URL /exec de tu WebApp desplegado */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjJQM1GL3WlXTrdIB1f6Bd0GTlZDl13pCa33v2Pp4S_ftlmRw4PBKOHk1bE_tUwtyj/exec';

/* Token de sesi√≥n, usuario logueado, listas cacheadas, par√°metro aid del correo */
let TOKEN=null, USER=null, LISTAS=null, AID_PARAM=null;

/* ========= HELPERS ========= */
const $=id=>document.getElementById(id);
const pad=n=>String(n).padStart(2,'0');
const toDMY=(d)=>`${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
const fromDateInput=(val)=>{ // yyyy-MM-dd -> dd-MM-yyyy
  if(!val) return '';
  const [y,m,d]=val.split('-'); return `${d}-${m}-${y}`;
};
const toDateInput=(dmy)=>{ // dd-MM-yyyy -> yyyy-MM-dd
  if(!dmy) return '';
  const [d,m,y]=dmy.split('-'); return `${y}-${m}-${d}`;
};
const setMsg=(el,html)=>{ el.innerHTML = html; };

const onlyDigits = s => (s||'').replace(/[^\d]/g,'');
const parseCOP = s => Number(onlyDigits(String(s)))||0;
const fmtCOP   = n => '$ ' + (Number(n)||0).toLocaleString('es-CO');

/** Pone valor en un input de dinero manteniendo raw en data-raw */
function setMoneyInput(el, n){
  el.dataset.raw = String(Number(n)||0);
  el.value = fmtCOP(n);
}
function getMoney(el){
  if(!el) return 0;
  if (el.dataset && el.dataset.raw !== undefined) return Number(el.dataset.raw)||0;
  return parseCOP(el.value);
}

/** Aplica m√°scara de dinero a un input y recalcula */
function attachMoneyMask(id){
  const el=$(id);
  const onFormat=()=>{
    el.dataset.raw = String(parseCOP(el.value));
    el.value = fmtCOP(el.dataset.raw);
    recalcAuto();
  };
  el.addEventListener('input', ()=>{ el.dataset.raw = String(parseCOP(el.value)); });
  el.addEventListener('blur', onFormat);
  onFormat(); // formateo inicial
}

/* ========= LOGIN ========= */
async function login(){
  const api_key=$('apiKey').value.trim();
  setMsg($('loginMsg'),'Validando...');
  try{
    const body = { api_key };
    if (AID_PARAM) body.aid = AID_PARAM;

    const r=await fetch(WEB_APP_URL+'?path=login',{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'Error de login');

    TOKEN=j.token; USER=j.user;

    await cargarListas();

    if((USER.rol||'').toLowerCase()==='admin'){
      $('adminCard').classList.remove('hid');
      initAdminSelectors();
      syncAdminPreview();
    }else{
      $('formCard').classList.remove('hid');
      $('asesorId').value = USER.id;
      $('asesorNombre').value = USER.nombre;
      await cargarAsignacionDelDia();
      ['marcado','error','gastos','qr'].forEach(attachMoneyMask);
      recalcAuto();
    }

    $('loginCard').classList.add('hid');
    setMsg($('loginMsg'),'<span class="ok">Acceso concedido</span>');
  }catch(e){
    setMsg($('loginMsg'),'<span class="bad">'+(e.message||'Failed to fetch')+'</span>');
  }
}

/* ========= LISTAS ========= */
async function cargarListas(){
  const r=await fetch(WEB_APP_URL+'?path=listas');
  const j=await r.json();
  LISTAS=j;
  fillSelect('ciudad', j.ciudades,'id','nombre');
  $('ciudad').disabled = true;
}
function fillSelect(id,arr,valKey,txtKey){
  const sel=$(id); sel.innerHTML='';
  arr.forEach(o=>{
    const op=document.createElement('option');
    op.value=o[valKey]; op.textContent=o[txtKey];
    sel.appendChild(op);
  });
}

/* ========= ASESOR: obtener asignaci√≥n ========= */
async function cargarAsignacionDelDia(){
  try{
    const q = new URLSearchParams({ token: TOKEN });
    const r = await fetch(WEB_APP_URL+'?path=asignacion&'+q.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Sin asignaci√≥n');

    const a = j.asignacion;

    fillSelect('ciudad', LISTAS.ciudades,'id','nombre'); $('ciudad').value = a.ciudad_id;
    fillSelect('sede', LISTAS.sedes.filter(s=>s.ciudad_id===a.ciudad_id),'id','nombre'); $('sede').value = a.sede_id;
    fillSelect('maquina', LISTAS.maquinas.filter(m=>m.sede_id===a.sede_id),'id','id'); $('maquina').value = a.maquina_id;

    setMoneyInput($('meta'), a.meta_dia||0);
    $('fecha').value = a.fecha; // dd-MM-yyyy

    ['ciudad','sede','maquina','meta'].forEach(id=>$(id).disabled=true);
  }catch(e){
    setMsg($('msg'), '<span class="bad">No tienes asignaci√≥n vigente.</span>');
  }
}

/* ========= C√°lculos encadenados ========= */
function recalcAuto(){
  const marcado = getMoney($('marcado'));
  const error   = getMoney($('error'));
  const gastos  = getMoney($('gastos'));
  const qr      = getMoney($('qr'));
  const meta    = getMoney($('meta'));
  const cons    = getMoney($('consignacion'));

  const venta = Math.max(0, marcado - error);
  setMoneyInput($('venta'), venta);

  const tickets = Math.max(0, Math.trunc(venta / 13)); // ENTERO
  $('tickets').value = tickets;

  const efectivo = Math.max(0, venta - gastos - qr);
  setMoneyInput($('efectivo'), efectivo);

  const pendiente = Math.max(0, efectivo - cons);
  setMoneyInput($('pendiente'), pendiente);

  const faltante = Math.max(0, meta - venta); // 0 si cumpli√≥/super√≥
  setMoneyInput($('faltante'), faltante);

  // feedback desempe√±o
  const fb = $('feedback');
  if (faltante === 0){
    fb.innerHTML = `<div class="pill ok">üî∫ <b>Meta cumplida.</b> ¬°Buen cierre!</div>`;
  }else{
    fb.innerHTML = `<div class="pill bad">üîª <b>No cumpliste la meta.</b> Vamos que se puede: ajusta estrategia y conc√©ntrate en los picos de afluencia.</div>`;
  }
}
['marcado','error','gastos','qr'].forEach(id=>{
  document.addEventListener('input', e=>{ if(e.target && e.target.id===id) recalcAuto(); });
});

/* ========= Upload a Drive ========= */
/**
 * Sube archivo a Drive. Si falla por alg√∫n motivo,
 * devuelve cadena vac√≠a para NO romper el env√≠o completo.
 */
async function uploadFile(file){
  if(!file) return '';
  try{
    const base64 = await new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res(String(fr.result).split(',')[1]);
      fr.onerror=rej;
      fr.readAsDataURL(file);
    });
    const r=await fetch(WEB_APP_URL+'?path=upload',{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({
        token:TOKEN,
        fileName:file.name,
        mimeType:file.type,
        data:base64
      })
    });
    const j=await r.json();
    if(!j.ok) return '';
    return j.url||'';
  }catch(e){
    console.error('Error subiendo archivo',e);
    return '';
  }
}

/* ========= Confirmaci√≥n y env√≠o ========= */
function abrirPreviewEnvio(){
  recalcAuto();
  const html = `
  <div><b>Asesor:</b> ${$('asesorNombre').value}</div>
  <div><b>Fecha:</b> ${$('fecha').value}</div>
  <div><b>Ciudad:</b> ${$('ciudad').options[$('ciudad').selectedIndex].text}</div>
  <div><b>Sede:</b> ${$('sede').options[$('sede').selectedIndex].text}</div>
  <div><b>M√°quina:</b> ${$('maquina').value}</div>
  <div><b>Meta del d√≠a:</b> ${$('meta').value}</div>
  <hr style="border-color:#1f2937;margin:8px 0">
  <div><b>Marcado:</b> ${$('marcado').value}</div>
  <div><b>Error:</b> ${$('error').value}</div>
  <div><b>Gastos:</b> ${$('gastos').value}</div>
  <div><b>QR:</b> ${$('qr').value}</div>
  <div><b>Venta total:</b> ${$('venta').value}</div>
  <div><b>Tickets vendidos:</b> ${$('tickets').value}</div>
  <div><b>Efectivo:</b> ${$('efectivo').value}</div>
  <div><b>Pendiente por consignar:</b> ${$('pendiente').value}</div>
  <div><b>Faltante de Meta:</b> ${$('faltante').value}</div>
  <div><b>Comentario:</b> ${$('comentario').value||'-'}</div>`;
  $('sendPreview').innerHTML = html;
  $('sendModal').style.display='flex';
  $('btnSendCancel').onclick = ()=> $('sendModal').style.display='none';
  $('btnSendConfirm').onclick = ()=> { $('sendModal').style.display='none'; enviar(); };
}

async function enviar(){
  setMsg($('msg'),'Subiendo archivos y enviando...');
  try{
    const foto_url = await uploadFile($('foto').files[0]);
    const video_url= await uploadFile($('video').files[0]);

    const payload={
      fecha:$('fecha').value,
      ciudad_id:$('ciudad').value,
      sede_id:$('sede').value,
      maquina_id:$('maquina').value,
      asesor_id:$('asesorId').value,
      marcado:getMoney($('marcado')),
      error:getMoney($('error')),
      tickets_vendidos: Number($('tickets').value)||0,
      venta_total:getMoney($('venta')),
      meta_dia:getMoney($('meta')),
      gastos:getMoney($('gastos')),
      qr:getMoney($('qr')),
      efectivo:getMoney($('efectivo')),
      consignacion:getMoney($('consignacion')),
      pendiente_consignar:getMoney($('pendiente')),
      faltante_meta:getMoney($('faltante')),
      comentario:$('comentario').value||'',
      foto_url, video_url
    };

    const r=await fetch(WEB_APP_URL+'?path=reporte',{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({token:TOKEN,payload})
    });
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'Error al registrar');

    setMsg($('msg'),'<span class="ok">‚úÖ Reporte registrado. Tu acceso queda bloqueado por hoy.</span>');
    bloquearFormulario();
  }catch(e){
    setMsg($('msg'),'<span class="bad">‚ùå '+(e.message||'Failed to fetch')+'</span>');
  }
}

/** Bloquea formulario tras enviar */
function bloquearFormulario(){
  ['marcado','error','gastos','qr','comentario','foto','video'].forEach(id=>{
    const el=$(id); if(el) el.disabled=true;
  });
  $('btnEnviar').disabled = true;
}

/* ========= ADMIN ========= */
function initAdminSelectors(){
  fillSelect('a_ciudad', LISTAS.ciudades,'id','nombre');

  $('a_ciudad').addEventListener('change', ()=>{
    const cid=$('a_ciudad').value;
    fillSelect('a_sede', LISTAS.sedes.filter(s=>s.ciudad_id===cid),'id','nombre');
    $('a_sede').dispatchEvent(new Event('change'));
  });

  $('a_sede').addEventListener('change', ()=>{
    const sid=$('a_sede').value;
    fillSelect('a_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
    fillSelect('del_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
    syncAdminPreview();
  });

  const asesores=(LISTAS.usuarios||[]).filter(
    u=>(u.rol||'').toLowerCase()==='asesor' && String(u.activo).toLowerCase()==='true'
  );
  fillSelect('a_asesor', asesores,'id','nombre');
  fillSelect('del_asesor', asesores,'id','nombre');

  attachMoneyMask('a_meta');

  $('a_fecha').value = toDateInput(toDMY(new Date())); // hoy

  ['a_asesor','a_meta','a_fecha'].forEach(id=>$(id).addEventListener('input', syncAdminPreview));
  $('a_ciudad').dispatchEvent(new Event('change'));

  $('btnAdminGuardar').addEventListener('click', adminGuardar);
  $('btnDelete').addEventListener('click', adminDeleteReport);
  syncAdminPreview();
}

function syncAdminPreview(){
  const ciudad = $('a_ciudad').options[$('a_ciudad').selectedIndex]?.text || '';
  const sede   = $('a_sede').options[$('a_sede').selectedIndex]?.text || '';
  const maq    = $('a_maquina').value || '';
  const asesor = $('a_asesor').options[$('a_asesor').selectedIndex]?.text || '';
  const meta   = getMoney($('a_meta'));
  const fechaDMY = fromDateInput($('a_fecha').value);

  $('adminPreview').innerHTML =
    `<div><b>Fecha:</b> ${fechaDMY}</div>
     <div><b>Ciudad:</b> ${ciudad}</div>
     <div><b>Sede:</b> ${sede}</div>
     <div><b>M√°quina:</b> ${maq}</div>
     <div><b>Asesor:</b> ${asesor}</div>
     <div><b>Meta del d√≠a:</b> ${fmtCOP(meta)}</div>`;
}

async function adminGuardar(){
  const msg=$('adminMsg'); setMsg(msg,'Guardando...');
  try{
    const q=new URLSearchParams({
      token:TOKEN,
      ciudad_id:$('a_ciudad').value,
      sede_id:$('a_sede').value,
      maquina_id:$('a_maquina').value,
      asesor_id:$('a_asesor').value,
      meta_sugerida:String(getMoney($('a_meta'))||0),
      fecha: fromDateInput($('a_fecha').value)
    });
    const r=await fetch(WEB_APP_URL+'?path=admin_set&'+q.toString());
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'No se pudo guardar');
    setMsg(msg,'<span class="ok">‚úî Guardado y notificado por email</span>');
  }catch(e){
    setMsg($('adminMsg'),'<span class="bad">‚ùå '+(e.message||'Failed to fetch')+'</span>');
  }
}

async function adminDeleteReport(){
  const msg=$('adminMsg'); setMsg(msg,'Eliminando...');
  try{
    const body = {
      token:TOKEN,
      asesor_id:$('del_asesor').value,
      maquina_id:$('del_maquina').value||'',
      fecha: fromDateInput($('del_fecha').value)
    };
    const r=await fetch(WEB_APP_URL+'?path=admin_delete',{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify(body)
    });
    const j=await r.json();

    if (!j.ok){
      setMsg(msg, `<span class="bad">‚ùå ${j.error || 'No hay reporte para eliminar'}</span>`);
      return;
    }
    setMsg(msg, `<span class="ok">‚úî Eliminado: reportes=${j.removed_reportes||0}, asignaciones=${j.removed_asignaciones||0}</span>`);
  }catch(e){
    setMsg($('adminMsg'), `<span class="bad">‚ùå ${(e.message||'Failed to fetch')}</span>`);
  }
}

/* ========= INIT ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  const url = new URL(location.href);
  AID_PARAM = url.searchParams.get('aid') || null;
  $('btnLogin').addEventListener('click', login);
  $('btnEnviar').addEventListener('click', abrirPreviewEnvio);
});
</script>
</body>
</html>
