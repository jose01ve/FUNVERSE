<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUNVENSER</title>
<style>
  :root{--bg:#0f172a;--card:#0f172a;--text:#e5e7eb;--muted:#9aa4bf;--border:#24304a;--accent:#7c83ff}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,var(--bg),#0b1224);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:auto;padding:16px}
  .card{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter: blur(4px)}
  h1{margin:.2rem 0 1rem;font-size:1.2rem}
  label{display:block;margin-top:10px;font-size:.92rem;color:var(--muted)}
  input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
  input[readonly], select:disabled, textarea[readonly]{opacity:.85;cursor:not-allowed}
  button{cursor:pointer;margin-top:14px;background:var(--accent);border-color:transparent}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
  .ok{color:#58d68d} .bad{color:#ff6b6b} .muted{color:var(--muted)}
  .hid{display:none}

  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:24px 16px}
  .logo{width:64px;height:64px;border-radius:16px;background:conic-gradient(from 120deg,#7c83ff,#00e5ff,#00ffa5);box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .title{font-weight:700;font-size:1.4rem}
  .subtitle{color:#9aa4bf;font-size:.95rem}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal .content{background:var(--card);border:1px solid var(--border);border-radius:12px;max-width:620px;width:100%;padding:16px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn-outline{background:transparent;border:1px solid var(--border)}
  .preview{background:#0b1224;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px}
  .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #223}
  .row:last-child{border-bottom:none}
  .k{color:#9aa4bf}.v{font-weight:600}
  .split{display:grid;gap:12px}
  @media(min-width:900px){ .split{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="hero">
      <div class="logo"></div>
      <div class="title">Ingresar · FUNVENSER</div>
      <div class="subtitle">Usa tu API Key para acceder</div>
    </div>
    <label>API Key</label>
    <input id="apiKey" placeholder="Ingresa tu API Key (ej. 123)" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <!-- ADMIN -->
  <div class="card hid" id="adminCard">
    <h1>Admin · Asignación y Meta</h1>
    <div class="grid grid-2">
      <div><label>Ciudad</label><select id="a_ciudad"></select></div>
      <div><label>Sede</label><select id="a_sede"></select></div>
      <div><label>Máquina</label><select id="a_maquina"></select></div>
      <div><label>Asesor</label><select id="a_asesor"></select></div>
      <div><label>Meta del día</label><input id="a_meta" type="number" min="0" step="1000" value="0" /></div>
    </div>
    <button id="btnAdminGuardar">Guardar asignación/meta</button>

    <h1 style="margin-top:22px">Acción rápida</h1>
    <div class="grid grid-2">
      <div>
        <label>Eliminar reporte de HOY (máquina del combo + asesor seleccionado)</label>
      </div>
      <div>
        <button class="btn-outline" id="btnAdminDelete">Eliminar reporte HOY</button>
      </div>
    </div>
    <div id="adminMsg" class="muted"></div>
  </div>

  <!-- PREVIEW ADMIN (vista previa de lo asignado) -->
  <div class="card hid" id="adminPreview">
    <h1>Reporte Diario · Vista previa (lo que verá el asesor)</h1>
    <div class="grid grid-2">
      <input id="p_asesorId" class="hid" />
      <div><label>Asesor</label><input id="p_asesorNombre" readonly /></div>
      <div><label>Fecha</label><input id="p_fecha" readonly /></div>

      <div><label>Ciudad</label><input id="p_ciudad" readonly /></div>
      <div><label>Sede</label><input id="p_sede" readonly /></div>
      <div><label>Máquina</label><input id="p_maquina" readonly /></div>

      <div><label>Marcado (monto en $)</label><input value="0" readonly /></div>
      <div><label>Error (monto en $)</label><input value="0" readonly /></div>

      <div><label>Tickets (auto)</label><input value="0" readonly /></div>
      <div><label>Venta total (auto)</label><input value="0" readonly /></div>

      <div><label>Meta del día (admin)</label><input id="p_meta" readonly /></div>
      <div><label>Gastos</label><input value="0" readonly /></div>

      <div><label>QR</label><input value="0" readonly /></div>
      <div><label>Efectivo (auto)</label><input value="0" readonly /></div>
      <div><label>Consignación (la edita Admin)</label><input value="0" readonly /></div>
      <div><label>Pendiente (auto)</label><input value="0" readonly /></div>

      <div style="grid-column:1 / -1"><label>Comentario</label><textarea rows="2" readonly>Observaciones del día</textarea></div>
    </div>
  </div>

  <!-- ASESOR FORM -->
  <div class="card hid" id="formCard">
    <h1>Reporte Diario</h1>
    <div class="grid grid-2">
      <input id="asesorId" class="hid" />
      <div><label>Asesor</label><input id="asesorNombre" readonly /></div>
      <div><label>Fecha</label><input type="date" id="fecha" readonly /></div>

      <div><label>Ciudad</label><select id="ciudad" disabled></select></div>
      <div><label>Sede (Centro Comercial)</label><select id="sede" disabled></select></div>
      <div><label>Máquina</label><select id="maquina" disabled></select></div>

      <div><label>Marcado (monto en $)</label><input id="marcado" type="number" min="0" step="1000" value="0" /></div>
      <div><label>Error (monto en $)</label><input id="error" type="number" min="0" step="1000" value="0" placeholder="0 si no hubo" /></div>

      <div><label>Tickets vendidos (auto)</label><input id="tickets" type="number" readonly value="0" /></div>
      <div><label>Venta total (auto)</label><input id="venta" type="number" readonly value="0" /></div>

      <div><label>Meta del día (admin)</label><input id="meta" type="number" readonly value="0" /></div>
      <div><label>Gastos</label><input id="gastos" type="number" min="0" step="500" value="0" /></div>

      <div><label>QR</label><input id="qr" type="number" min="0" step="1000" value="0" /></div>
      <div><label>Efectivo (auto)</label><input id="efectivo" type="number" readonly value="0" /></div>
      <div><label>Consignación (la edita Admin)</label><input id="consignacion" type="number" disabled value="0" /></div>
      <div><label>Pendiente por consignar (auto)</label><input id="pendiente" type="number" readonly value="0" /></div>

      <div style="grid-column:1 / -1">
        <label>Comentario</label>
        <textarea id="comentario" rows="3" placeholder="Observaciones del día"></textarea>
      </div>

      <div><label>Foto (jpg/png)</label><input id="foto" type="file" accept="image/*" /></div>
      <div><label>Video (mp4/quicktime)</label><input id="video" type="file" accept="video/*" /></div>
    </div>

    <button id="btnEnviar">Enviar reporte</button>
    <div id="msg" class="muted"></div>
  </div>
</div>

<!-- Modal Confirmación envío -->
<div class="modal" id="sendModal" role="dialog" aria-modal="true">
  <div class="content">
    <h3>Confirmar envío</h3>
    <p class="muted">Revisa los valores. Después de enviar, no podrás modificarlo.</p>
    <div id="preview" class="preview"></div>
    <div class="actions">
      <button class="btn-outline" id="btnSendCancel">Cancelar</button>
      <button id="btnSendConfirm">Sí, enviar</button>
    </div>
  </div>
</div>

<!-- Modal Confirmación Asignación -->
<div class="modal" id="assignModal" role="dialog" aria-modal="true">
  <div class="content">
    <h3>Confirmar asignación/meta</h3>
    <div id="assignPreview" class="preview"></div>
    <div class="actions">
      <button class="btn-outline" id="btnAssignCancel">Cancelar</button>
      <button id="btnAssignConfirm">Sí, guardar</button>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwOsgHmYZjn3_WajCwdLTODY8WCjfGvsQLSLjMx7mB69Y95T8bvOafFkZxVDmQJdVYd/exec';

/* ============ Estado global ============ */
let TOKEN=null, USER=null, LISTAS=null;
let AID = new URLSearchParams(location.search).get('aid') || '';

/* ============ Helpers ============ */
const $=id=>document.getElementById(id);
const todayStr=()=>new Date().toISOString().slice(0,10);
function lockToday(){ $('fecha').value=todayStr(); $('fecha').readOnly=true; }
const num = id => +((($(id)?.value)||'0').toString().replace(/[, ]/g,'')) || 0;
function money(n){ return (+n||0).toLocaleString('es-CO'); }
function disableSend(msg){ $('btnEnviar').disabled=true; $('msg').innerHTML=`<span class="bad">${msg}</span>`; }
function sentKey(){ return `sent_${$('fecha').value}_${$('maquina').value}_${$('asesorId').value}`; }

/* ============ Login ============ */
async function login(){
  const api_key=$('apiKey').value.trim();
  $('loginMsg').textContent='Validando...';
  try{
    const r=await fetch(WEB_APP_URL+'?path=login',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({api_key})});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error de login');
    TOKEN=j.token; USER=j.user;

    // Si viene enlace de asesor ?aid=..., exigir coincidencia SOLO si rol es asesor
    if (AID && (USER.rol||'').toLowerCase()==='asesor' && USER.id!==AID){
      $('loginMsg').innerHTML='<span class="bad">Este enlace no corresponde a tu usuario.</span>';
      TOKEN=null; USER=null; return;
    }

    await cargarListas();

    if ((USER.rol||'').toLowerCase()==='admin'){
      // Panel admin
      initAdmin();
      $('adminCard').classList.remove('hid');
      $('adminPreview').classList.remove('hid');
    } else {
      // Asesor
      $('asesorNombre').value=USER.nombre||''; $('asesorId').value=USER.id||'';
      lockToday();
      await cargarAsignacionAsesor();
      lockAsesorUI();
      recalcAuto();
      const sk = localStorage.getItem(sentKey());
      if (sk==='1') disableSend('Ya enviaste este reporte hoy.');
      $('formCard').classList.remove('hid');
    }

    $('loginCard').classList.add('hid');
  }catch(e){
    $('loginMsg').innerHTML='<span class="bad">'+e.message+'</span>';
  }
}

/* ============ Listas ============ */
async function cargarListas(){
  const r=await fetch(WEB_APP_URL+'?path=listas'); LISTAS=await r.json();
}

/* ============ ADMIN UI ============ */
function initAdmin(){
  // Combos
  fillSelect('a_ciudad', LISTAS.ciudades,'id','nombre');
  $('a_ciudad').addEventListener('change', ()=>{
    const cid=$('a_ciudad').value;
    fillSelect('a_sede', LISTAS.sedes.filter(s=>s.ciudad_id===cid),'id','nombre');
    $('a_sede').dispatchEvent(new Event('change'));
  });
  $('a_sede').addEventListener('change', ()=>{
    const sid=$('a_sede').value;
    fillSelect('a_maquina', LISTAS.maquinas.filter(m=>m.sede_id===sid),'id','id');
    syncAdminPreview();
  });

  const asesores=(LISTAS.usuarios||[]).filter(u=>(u.rol||'').toLowerCase()==='asesor' && String(u.activo).toLowerCase()==='true');
  fillSelect('a_asesor', asesores,'id','nombre');

  $('a_asesor').addEventListener('change', syncAdminPreview);
  $('a_meta').addEventListener('input',  syncAdminPreview);
  $('a_ciudad').dispatchEvent(new Event('change'));
  syncAdminPreview();

  // Guardar asignación (con confirmación)
  $('btnAdminGuardar').addEventListener('click', openAssignConfirm);
  // Eliminar reporte HOY
  $('btnAdminDelete').addEventListener('click', adminDeleteToday);
}

function fillSelect(id,arr,valKey,txtKey){
  const sel=$(id); sel.innerHTML='';
  (arr||[]).forEach(o=>{
    const op=document.createElement('option');
    op.value=o[valKey]; op.textContent=o[txtKey];
    sel.appendChild(op);
  });
}

function syncAdminPreview(){
  const cid=$('a_ciudad').value, sid=$('a_sede').value, mid=$('a_maquina').value;
  const asesorId=$('a_asesor').value;
  const asesorNombre=$('a_asesor').options[$('a_asesor').selectedIndex]?.text||'';
  $('p_asesorId').value=asesorId; $('p_asesorNombre').value=asesorNombre;
  $('p_fecha').value=todayStr();
  $('p_ciudad').value=(LISTAS.ciudades.find(c=>c.id===cid)||{}).nombre||cid;
  $('p_sede').value=(LISTAS.sedes.find(s=>s.id===sid)||{}).nombre||sid;
  $('p_maquina').value=mid;
  $('p_meta').value=+$('a_meta').value||0;
}

function openAssignConfirm(){
  const cid=$('a_ciudad').options[$('a_ciudad').selectedIndex]?.text||'';
  const sid=$('a_sede').options[$('a_sede').selectedIndex]?.text||'';
  const mid=$('a_maquina').value;
  const an=$('a_asesor').options[$('a_asesor').selectedIndex]?.text||'';
  const meta=+$('a_meta').value||0;
  $('assignPreview').innerHTML = `
    <div class="row"><span class="k">Ciudad</span><span class="v">${cid}</span></div>
    <div class="row"><span class="k">Sede</span><span class="v">${sid}</span></div>
    <div class="row"><span class="k">Máquina</span><span class="v">${mid}</span></div>
    <div class="row"><span class="k">Asesor</span><span class="v">${an}</span></div>
    <div class="row"><span class="k">Meta del día</span><span class="v">$ ${meta.toLocaleString('es-CO')}</span></div>
  `;
  $('assignModal').style.display='flex';
  $('btnAssignCancel').onclick = ()=> $('assignModal').style.display='none';
  $('btnAssignConfirm').onclick = ()=> { $('assignModal').style.display='none'; adminGuardar(); };
}

async function adminGuardar(){
  const msg=$('adminMsg'); msg.textContent='Guardando...';
  try{
    const q=new URLSearchParams({
      token:TOKEN,
      ciudad_id:$('a_ciudad').value,
      sede_id:$('a_sede').value,
