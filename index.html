<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUNVENSER · Reporte Diario</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9aa4bf;--border:#24304a;--accent:#6366f1}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.15)}
  h1{margin:.2rem 0 1rem;font-size:1.2rem}
  label{display:block;margin-top:10px;font-size:.92rem;color:var(--muted)}
  input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
  input[readonly]{opacity:.85;cursor:not-allowed}
  button{cursor:pointer;margin-top:14px;background:var(--accent);border-color:transparent}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
  .ok{color:#58d68d} .bad{color:#ff6b6b} .muted{color:var(--muted)}

  /* Paleta arriba */
  .palette{display:flex;gap:8px;padding:10px;background:#0b1224;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  .swatch{width:28px;height:28px;border-radius:999px;border:2px solid #fff1;cursor:pointer;box-shadow:0 0 0 2px #0006}
  .swatch.active{outline:2px solid #fff8}
</style>
</head>
<body>
<!-- Paleta de colores -->
<div class="palette" id="palette"></div>

<div class="wrap">
  <div class="card" id="loginCard">
    <h1>Ingresar · FUNVENSER</h1>
    <label>API Key del Asesor</label>
    <input id="apiKey" placeholder="Ingresa tu API Key (ej. ASESOR-TEST-KEY)" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <div class="card" id="formCard" style="display:none">
    <h1>Reporte Diario</h1>

    <div class="grid grid-2">
      <div>
        <label>Asesor</label>
        <input id="asesorNombre" readonly />
      </div>
      <div>
        <label>ID Asesor</label>
        <input id="asesorId" readonly />
      </div>

      <div>
        <label>Fecha</label>
        <input type="date" id="fecha">
      </div>
      <div>
        <label>Ciudad</label>
        <select id="ciudad"></select>
      </div>
      <div>
        <label>Sede (Centro Comercial)</label>
        <select id="sede"></select>
      </div>
      <div>
        <label>Máquina</label>
        <select id="maquina"></select>
      </div>

      <div>
        <label>Marcado (monto en $)</label>
        <input id="marcado" type="number" min="0" step="1000" value="0" />
      </div>
      <div>
        <label>Error</label>
        <input id="error" placeholder="SIN ERROR si no hubo" />
      </div>

      <div>
        <label>Tickets vendidos</label>
        <input id="tickets" type="number" min="0" value="0" />
      </div>
      <div>
        <label>Venta total</label>
        <input id="venta" type="number" min="0" step="1000" value="0" />
      </div>

      <div>
        <label>Meta del día (definida por admin)</label>
        <input id="meta" type="number" min="0" step="1000" value="0" readonly />
      </div>
      <div>
        <label>Gastos</label>
        <input id="gastos" type="number" min="0" step="500" value="0" />
      </div>

      <div>
        <label>QR</label>
        <input id="qr" type="number" min="0" step="1000" value="0" />
      </div>
      <div>
        <label>Efectivo</label>
        <input id="efectivo" type="number" min="0" step="1000" value="0" />
      </div>
      <div>
        <label>Consignación</label>
        <input id="consignacion" type="number" min="0" step="1000" value="0" />
      </div>
      <div>
        <label>Pendiente por consignar</label>
        <input id="pendiente" type="number" min="0" step="1000" value="0" />
      </div>

      <div style="grid-column:1 / -1">
        <label>Comentario</label>
        <textarea id="comentario" rows="3" placeholder="Observaciones del día"></textarea>
      </div>

      <div>
        <label>Foto (jpg/png)</label>
        <input id="foto" type="file" accept="image/*" />
      </div>
      <div>
        <label>Video (mp4/quicktime)</label>
        <input id="video" type="file" accept="video/*" />
      </div>
    </div>

    <button id="btnEnviar">Enviar reporte</button>
    <div id="msg" class="muted"></div>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyk_xWSX9zIOr5burAOD00-afS28gTI7QHOba5EP6RZCkoGD1Jb6kyS4544JX_oLl8b/exec'; // <<<<<<<<<<<<<<<<<<<<<<<<<<

let TOKEN = null;
let USER = null;
let LISTAS = null;

// ---- Paleta de colores (4 temas) ----
const THEMES = [
  {bg:'#0f172a', card:'#111827', text:'#e5e7eb', muted:'#9aa4bf', border:'#24304a', accent:'#6366f1'},
  {bg:'#111111', card:'#1a1a1a', text:'#eaeaea', muted:'#9a9a9a', border:'#333333', accent:'#22c55e'},
  {bg:'#111827', card:'#0b1224', text:'#e5e7eb', muted:'#9aa4bf', border:'#1f2a44', accent:'#f59e0b'},
  {bg:'#0b1224', card:'#0f172a', text:'#dbeafe', muted:'#94a3b8', border:'#1e293b', accent:'#ef4444'}
];
function applyTheme(t){
  document.documentElement.style.setProperty('--bg', t.bg);
  document.documentElement.style.setProperty('--card', t.card);
  document.documentElement.style.setProperty('--text', t.text);
  document.documentElement.style.setProperty('--muted', t.muted);
  document.documentElement.style.setProperty('--border', t.border);
  document.documentElement.style.setProperty('--accent', t.accent);
  localStorage.setItem('fun_theme', JSON.stringify(t));
}
function renderPalette(){
  const pal = document.getElementById('palette'); pal.innerHTML='';
  THEMES.forEach((t)=>{
    const el = document.createElement('div'); el.className='swatch'; el.style.background=t.accent;
    el.onclick = ()=>{ applyTheme(t); document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active')); el.classList.add('active'); };
    pal.appendChild(el);
  });
  const saved = localStorage.getItem('fun_theme'); if(saved) applyTheme(JSON.parse(saved)); else applyTheme(THEMES[0]);
}

// ---- Helpers
function $(id){ return document.getElementById(id); }
function setDateToday(){ $('fecha').value = new Date().toISOString().slice(0,10); }

// ---- Login
async function login(){
  const api_key = $('apiKey').value.trim();
  $('loginMsg').textContent = 'Validando...';
  try{
    const r = await fetch(WEB_APP_URL + '?path=login', { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ api_key }) });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error de login');
    TOKEN = j.token; USER = j.user;
    $('asesorNombre').value = USER.nombre || '';
    $('asesorId').value = USER.id || '';
    $('loginMsg').innerHTML = '<span class="ok">Acceso concedido</span>';
    await cargarListas();
    setDateToday();
    $('loginCard').style.display='none';
    $('formCard').style.display='block';
  }catch(e){
    $('loginMsg').innerHTML = '<span class="bad">' + e.message + '</span>';
  }
}

// ---- Listas (y meta del día)
async function cargarListas(){
  const r = await fetch(WEB_APP_URL + '?path=listas');
  const j = await r.json();
  LISTAS = j;
  fillSelect('ciudad', j.ciudades, 'id', 'nombre');
  $('ciudad').addEventListener('change', onCiudadChange);
  $('sede').addEventListener('change', onSedeChange);
  onCiudadChange();
}

function fillSelect(id, arr, valueKey, textKey){
  const sel = $(id); sel.innerHTML = '';
  arr.forEach(o=>{
    const opt = document.createElement('option');
    opt.value = o[valueKey]; opt.textContent = o[textKey];
    sel.appendChild(opt);
  });
}

function onCiudadChange(){
  const cid = $('ciudad').value;
  const sedes = LISTAS.sedes.filter(s => s.ciudad_id === cid);
  fillSelect('sede', sedes, 'id', 'nombre');
  onSedeChange();
}
function onSedeChange(){
  const sid = $('sede').value;
  const maqs = LISTAS.maquinas.filter(m => m.sede_id === sid);
  fillSelect('maquina', maqs, 'id', 'id');
  // meta del día leída desde la máquina (columna "meta_sugerida" o "meta")
  setTimeout(()=>{
    const mId = $('maquina').value;
    const m = LISTAS.maquinas.find(x => x.id === mId);
    const meta = Number(m && (m.meta_sugerida || m.meta || 0)) || 0;
    $('meta').value = meta; // readonly
  }, 0);
}

// ---- Upload a Drive (foto/video)
async function uploadFile(file){
  if(!file) return '';
  const base64 = await toBase64(file);
  const body = { token: TOKEN, fileName: file.name, mimeType: file.type, data: base64 };
  const r = await fetch(WEB_APP_URL + '?path=upload', { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body) });
  const j = await r.json(); if(!j.ok) throw new Error(j.error || 'No se pudo subir');
  return j.url;
}
function toBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload=()=>res(String(fr.result).split(',')[1]);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

// ---- Enviar reporte
async function enviar(){
  $('msg').textContent = 'Subiendo archivos y enviando...';
  try{
    const foto_url  = await uploadFile($('foto').files[0]);
    const video_url = await uploadFile($('video').files[0]);

    const payload = {
      fecha: $('fecha').value,
      ciudad_id: $('ciudad').value,
      sede_id: $('sede').value,
      maquina_id: $('maquina').value,
      asesor_id: USER.id,
      marcado: +$('marcado').value || 0,  // dinero
      error: $('error').value || 'SIN ERROR',
      tickets_vendidos: +$('tickets').value || 0,
      venta_total: +$('venta').value || 0,
      meta_dia: +$('meta').value || 0,
      gastos: +$('gastos').value || 0,
      qr: +$('qr').value || 0,
      efectivo: +$('efectivo').value || 0,
      consignacion: +$('consignacion').value || 0,
      pendiente_consignar: +$('pendiente').value || 0,
      comentario: $('comentario').value || '',
      foto_url, video_url
    };

    const r = await fetch(WEB_APP_URL + '?path=reporte', { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ token: TOKEN, payload }) });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'Error al registrar');
    $('msg').innerHTML = '<span class="ok">✅ Reporte registrado</span>';
  }catch(e){
    $('msg').innerHTML = '<span class="bad">❌ ' + e.message + '</span>';
  }
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  renderPalette();
  $('btnLogin').addEventListener('click', login);
  $('btnEnviar').addEventListener('click', enviar);
});
</script>
</body>
</html>
